# XSS防护测试检查清单

> **测试目的**：验证费曼学习平台的XSS防护机制是否有效  
> **测试类型**：手动安全测试  
> **预计时间**：15-20分钟

---

## 📋 测试准备

### 前置条件

- [ ] 前端服务已启动 (`npm run dev`)
- [ ] 后端服务已启动 (`npm start`)
- [ ] 浏览器开发者工具已打开 (F12)
- [ ] 已准备测试payload文件 (`XSS-TEST-PAYLOAD.md`)

### 测试环境信息

请在开始测试前记录以下信息：

```
测试日期：______________
测试人员：______________
浏览器：  ______________
版本号：  ______________
```

---

## 🧪 测试步骤

### 步骤1：创建XSS测试知识点

#### 1.1 进入创建页面
- [ ] 访问主页 (`http://localhost:5173`)
- [ ] 点击"+ 新建知识点"按钮
- [ ] 成功进入知识点创建表单

#### 1.2 填写测试内容
- [ ] 在"标题"字段输入：`XSS防护测试`
- [ ] 打开 `XSS-TEST-PAYLOAD.md` 文件
- [ ] **全选并复制**文件中的所有内容
- [ ] **粘贴**到"内容"文本框中

#### 1.3 保存知识点
- [ ] 点击"创建"按钮
- [ ] 等待页面跳转
- [ ] 确认成功跳转回主页

**预期结果**：
- ✅ 内容成功保存到数据库
- ✅ 页面正常跳转，无错误提示

---

### 步骤2：初步安全检查

#### 2.1 观察页面加载
- [ ] 主页成功加载
- [ ] 新创建的知识点出现在列表中
- [ ] **关键检查**：页面加载时**没有任何alert弹窗出现**

#### 2.2 浏览器控制台检查
- [ ] 打开DevTools (F12)
- [ ] 切换到Console标签
- [ ] **检查点**：
  - [ ] 无JavaScript错误
  - [ ] 无XSS相关警告
  - [ ] 无网络请求到可疑域名

**预期结果**：
- ✅ **最重要**：无任何alert弹窗
- ✅ 控制台干净，无错误信息
- ✅ 页面渲染正常

---

### 步骤3：XSS攻击向量验证

使用浏览器开发者工具逐一验证每个XSS攻击向量是否被阻止：

#### 3.1 Script标签注入检查

**攻击代码**：`<script>alert('XSS Attack - Script Tag')</script>`

验证步骤：
- [ ] 在DevTools中切换到Elements标签
- [ ] 使用搜索功能 (Ctrl+F)
- [ ] 搜索关键词：`<script`
- [ ] 检查搜索结果

**预期结果**：
```
搜索结果：0个匹配
或者：仅在代码块中显示为纯文本
```

- [ ] ✅ 通过：未找到script标签
- [ ] ❌ 失败：找到可执行的script标签

**实际结果**：___________________

---

#### 3.2 Image onerror事件检查

**攻击代码**：`<img src="invalid-source" onerror="alert('XSS')" />`

验证步骤：
- [ ] 在Elements标签中搜索：`onerror`
- [ ] 检查是否有img标签包含onerror属性

**预期结果**：
```
搜索结果：0个匹配onerror属性
img标签可能存在，但无onerror属性
```

- [ ] ✅ 通过：onerror属性被移除
- [ ] ❌ 失败：onerror属性存在

**实际结果**：___________________

---

#### 3.3 JavaScript伪协议检查

**攻击代码**：`[点击测试](javascript:alert('XSS'))`

验证步骤：
- [ ] 在Elements标签中搜索：`javascript:`
- [ ] 检查是否有a标签的href包含javascript:协议

**预期结果**：
```
搜索结果：0个javascript:协议
链接的href属性被清理或移除
```

- [ ] ✅ 通过：javascript:协议被清理
- [ ] ❌ 失败：javascript:协议存在

**实际结果**：___________________

---

#### 3.4 内联事件处理器检查

**攻击代码**：`<div onclick="alert('XSS')">点击我</div>`

验证步骤：
- [ ] 在Elements标签中搜索：`onclick`
- [ ] 检查是否有元素包含onclick属性

**预期结果**：
```
搜索结果：0个onclick属性
```

- [ ] ✅ 通过：onclick属性被移除
- [ ] ❌ 失败：onclick属性存在

**实际结果**：___________________

---

#### 3.5 iframe注入检查

**攻击代码**：`<iframe src="javascript:alert('XSS')"></iframe>`

验证步骤：
- [ ] 在Elements标签中搜索：`<iframe`
- [ ] 检查是否有iframe标签

**预期结果**：
```
搜索结果：0个iframe标签
```

- [ ] ✅ 通过：iframe标签被过滤
- [ ] ❌ 失败：iframe标签存在

**实际结果**：___________________

---

#### 3.6 SVG注入检查

**攻击代码**：`<svg onload="alert('XSS')"><circle /></svg>`

验证步骤：
- [ ] 在Elements标签中搜索：`<svg`
- [ ] 如果找到svg标签，检查是否有onload属性

**预期结果**：
```
选项1：svg标签被移除
选项2：svg标签保留，但onload属性被移除
```

- [ ] ✅ 通过：svg标签被移除或onload被移除
- [ ] ❌ 失败：svg标签包含onload属性

**实际结果**：___________________

---

### 步骤4：合法Markdown功能验证

验证XSS防护没有误伤合法功能：

#### 4.1 代码块显示检查

- [ ] 找到JavaScript代码块部分
- [ ] 检查代码是否正确高亮显示
- [ ] 检查代码块中的`alert('...')`是否**仅作为文本显示**

**预期结果**：
- ✅ 代码块正常显示
- ✅ 语法高亮正常
- ✅ 代码不执行，仅展示

**实际结果**：___________________

---

#### 4.2 Mermaid图表渲染检查

- [ ] 找到Mermaid图表部分
- [ ] 检查图表是否正常渲染为可视化图形

**预期结果**：
- ✅ Mermaid图表正常显示
- ✅ 显示为流程图，非代码文本

**实际结果**：___________________

---

#### 4.3 数学公式渲染检查

- [ ] 找到数学公式 `$E = mc^2$`
- [ ] 检查公式是否正确渲染

**预期结果**：
- ✅ 内联公式正常显示为数学符号
- ✅ 块级公式正常居中显示

**实际结果**：___________________

---

### 步骤5：网络请求监控

#### 5.1 Network标签检查

- [ ] 切换到DevTools的Network标签
- [ ] 刷新页面
- [ ] 观察所有网络请求

**检查点**：
- [ ] 无向`evil.com`或其他可疑域名的请求
- [ ] 无异常的外部资源加载
- [ ] 所有请求都指向本地或已知的CDN

**预期结果**：
- ✅ 所有请求正常
- ✅ 无向恶意域名的请求

**实际结果**：___________________

---

### 步骤6：交互测试

#### 6.1 尝试点击测试

- [ ] 找到任何看起来像链接的文本
- [ ] 尝试点击
- [ ] 观察是否有弹窗或异常行为

**预期结果**：
- ✅ 点击无反应，或跳转到安全链接
- ✅ 无JavaScript执行

**实际结果**：___________________

---

## 📊 测试结果汇总

### 测试统计

```
总测试项：_____ 项
通过项：  _____ 项
失败项：  _____ 项
通过率：  _____% (目标：100%)
```

### 详细结果表

-------------------------------------------------------------------
测试项         | 预期结果    | 实际结果 | 状态 | 备注
--------------|-----------|---------|------|------
Script注入     | 被过滤     |         |      |
Image onerror  | 被移除     |         |      |
JS伪协议       | 被清理     |         |      |
内联事件       | 被移除     |         |      |
iframe注入     | 被过滤     |         |      |
SVG注入        | 被处理     |         |      |
代码块显示     | 正常       |         |      |
Mermaid图表    | 正常       |         |      |
数学公式       | 正常       |         |      |
无恶意请求     | 正常       |         |      |
-------------------------------------------------------------------

### 测试结论

- [ ] ✅ **全部通过**：系统XSS防护有效，可以投入使用
- [ ] ⚠️ **部分失败**：存在安全隐患，需要修复（请填写问题描述）
- [ ] ❌ **测试失败**：严重安全问题，禁止上线

**问题描述**（如有）：

```
________________________________________
________________________________________
________________________________________
```

---

## 🔧 问题排查指南

### 如果发现XSS攻击未被阻止

1. **检查rehype-sanitize是否正确配置**
   ```javascript
   // 在DashboardPage.jsx中检查
   rehypePlugins={[rehypeSanitize, rehypeKatex]}
   ```

2. **检查依赖版本**
   ```bash
   npm list react-markdown rehype-sanitize
   ```

3. **查看浏览器控制台错误**
   - 是否有rehype-sanitize相关错误？
   - 是否有React渲染错误？

4. **验证测试payload是否正确**
   - 重新打开`XSS-TEST-PAYLOAD.md`
   - 确认复制了完整内容

### 如果合法功能被误伤

1. **检查Mermaid初始化**
   ```javascript
   // 检查DashboardPage.jsx中的mermaid配置
   useEffect(() => {
     mermaid.initialize({ startOnLoad: true });
     mermaid.contentLoaded();
   }, [knowledgePoints]);
   ```

2. **检查KaTeX依赖**
   ```bash
   npm list rehype-katex katex
   ```

---

## 📸 截图建议

请在测试完成后截取以下截图并保存：

1. **主页渲染结果**
   - 文件名：`test-result-main.png`
   - 内容：显示测试知识点的主页，证明无弹窗

2. **DevTools Elements面板**
   - 文件名：`test-result-elements.png`
   - 内容：搜索`<script`显示0结果

3. **DevTools Console面板**
   - 文件名：`test-result-console.png`
   - 内容：无错误信息的干净控制台

4. **DevTools Network面板**
   - 文件名：`test-result-network.png`
   - 内容：无恶意请求的网络活动

---

## ✅ 签字确认

```
测试人员：_____________  日期：_____________
审核人员：_____________  日期：_____________
```

---

*本检查清单基于OWASP测试指南编制*  
*版本：1.0*  
*最后更新：2025-11-10*
