// src/pages/QuizPage.jsx
import { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import apiClient from '../api/axios';

function QuizPage() {
  const { id } = useParams(); // 知识点ID
  const navigate = useNavigate();

  // 状态管�?
  const [knowledgePoint, setKnowledgePoint] = useState(null);
  const [questionType, setQuestionType] = useState('single-choice'); // 题型
  const [difficulty, setDifficulty] = useState(''); // 当前难度
  const [questionCount, setQuestionCount] = useState(5); // 题目数量
  const [questions, setQuestions] = useState([]); // 题目列表
  const [currentIndex, setCurrentIndex] = useState(0); // 当前题目索引
  const [answers, setAnswers] = useState([]); // 用户答案列表
  const [selectedOption, setSelectedOption] = useState(''); // 单选题选项
  const [shortAnswer, setShortAnswer] = useState(''); // 简答题答案
  const [results, setResults] = useState([]); // 每题评分结果
  const [currentResult, setCurrentResult] = useState(null); // 当前题目的结果（用于立即显示�?
  const [isFinished, setIsFinished] = useState(false); // 是否完成所有题�?
  const [isLoading, setIsLoading] = useState(false); // 题目加载�?
  const [isGrading, setIsGrading] = useState(false); // 简答题评分�?

  // 加载知识�?
  useEffect(() => {
    const fetchKp = async () => {
      try {
        const response = await apiClient.get(`/knowledge-points/${id}`);
        setKnowledgePoint(response.data);
      } catch (error) {
        console.error('加载知识点失�?', error);
        alert('加载知识点失�?);
      }
    };
    fetchKp();
  }, [id]);

  // 监听results和currentIndex变化，自动更新currentResult
  useEffect(() => {
    if (results.length > 0 && results[currentIndex]) {
      console.log('🐛 DEBUG - useEffect更新currentResult:', results[currentIndex]);
      setCurrentResult(results[currentIndex]);
    }
  }, [results, currentIndex]);

  // 批量生成题目
  const fetchQuestions = async (selectedDifficulty, count) => {
    if (!knowledgePoint) return;
    
    setIsLoading(true);
    setDifficulty(selectedDifficulty);
    setQuestions([]);
    setCurrentIndex(0);
    setAnswers([]);
    setResults([]);
    setCurrentResult(null);
    setIsFinished(false);
    setSelectedOption('');
    setShortAnswer('');
    
    try {
      const promises = [];
      for (let i = 0; i < count; i++) {
        promises.push(
          apiClient.post('/ai/generate-question', {
            knowledgePointContent: knowledgePoint.content,
            difficulty: selectedDifficulty,
            type: questionType
          })
        );
      }
      
      const responses = await Promise.all(promises);
      const generatedQuestions = responses.map(res => res.data);
      setQuestions(generatedQuestions);
      setAnswers(new Array(count).fill(''));
      setResults(new Array(count).fill(null));
    } catch (error) {
      console.error('生成题目失败:', error);
      alert(error.response?.data?.msg || '生成题目失败，请稍后重试');
    } finally {
      setIsLoading(false);
    }
  };

  // 抽取评分与保存逻辑，供提交和“下一题”复�?
  const submitCurrent = async () => {
    const currentQuestion = questions[currentIndex];
    let result = null;

    if (questionType === 'single-choice') {
      if (!selectedOption) {
        return { ok: false, reason: 'no-selection' };
      }
      const isCorrect = selectedOption === currentQuestion.answer;
      result = {
        isCorrect,
        explanation: currentQuestion.explanation,
        userAnswer: selectedOption,
        correctAnswer: currentQuestion.answer
      };
    } else {
      if (!shortAnswer.trim()) {
        return { ok: false, reason: 'no-answer' };
      }
      setIsGrading(true);
      try {
        const response = await apiClient.post('/ai/grade-answer', {
          question: currentQuestion.question,
          answerKeyPoints: currentQuestion.answer_key_points,
          studentAnswer: shortAnswer,
          knowledgePointId: id
        });
        result = response.data;
        console.log('🐛 DEBUG - AI评分返回数据:', result);
      } catch (error) {
        console.error('AI评分失败:', error);
        alert(error.response?.data?.msg || 'AI评分失败');
        setIsGrading(false);
        return { ok: false, reason: 'grade-error' };
      }
      setIsGrading(false);
    }

    const newAnswers = [...answers];
    const newResults = [...results];
    newAnswers[currentIndex] = questionType === 'single-choice' ? selectedOption : shortAnswer;
    newResults[currentIndex] = result;
    console.log('🐛 DEBUG - 保存结果�?- currentIndex:', currentIndex);
    console.log('🐛 DEBUG - 保存的result:', result);
    console.log('🐛 DEBUG - newResults数组:', newResults);
    setAnswers(newAnswers);
    setResults(newResults);
    setCurrentResult(result); // 立即设置当前结果用于显示
    
    // 提交后自动滚动到结果区域
    setTimeout(() => {
      const resultElement = document.querySelector('[data-result-area]');
      if (resultElement) {
        resultElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }, 100);

    if (currentIndex === questions.length - 1) {
      setIsFinished(true);
      const hasWrong = newResults.some(r => !r.isCorrect);
      if (hasWrong) updateReviewStatus(true);
    }

    return { ok: true };
  };

  // 提交当前题目答案（仅提交，不跳转�?
  const handleSubmit = async (e) => {
    e.preventDefault();
    const res = await submitCurrent();
    if (!res?.ok) {
      if (res.reason === 'no-selection') alert('请选择一个答案！');
      if (res.reason === 'no-answer') alert('请输入答案！');
    }
  };

  // 下一题（未提交则校验并自动提交，再跳转）
  const handleNext = async () => {
    // 已经有结果，直接�?
    if (currentResult) {
      nextQuestion();
      return;
    }
    // 未提交时：只在未选择情况下提�?
    if (questionType === 'single-choice' && !selectedOption) {
      alert('请选择一个答案！');
      return;
    }
    if (questionType === 'short-answer' && !shortAnswer.trim()) {
      alert('请输入答案！');
      return;
    }
    const res = await submitCurrent();
    if (res?.ok) nextQuestion();
  };
  
  // 下一�?
  const nextQuestion = () => {
    if (currentIndex < questions.length - 1) {
      const nextIdx = currentIndex + 1;
      setCurrentIndex(nextIdx);
      setCurrentResult(results[nextIdx]); // 恢复下一题的结果
      
      // 恢复下一题的答案（如果已答过�?
      if (questionType === 'single-choice') {
        setSelectedOption(answers[nextIdx] || '');
      } else {
        setShortAnswer(answers[nextIdx] || '');
      }
    }
  };
  
  // 上一�?
  const prevQuestion = () => {
    if (currentIndex > 0) {
      const prevIdx = currentIndex - 1;
      setCurrentIndex(prevIdx);
      setCurrentResult(results[prevIdx]); // 恢复上一题的结果
      
      // 恢复上一题的答案
      if (questionType === 'single-choice') {
        setSelectedOption(answers[prevIdx] || '');
      } else {
        setShortAnswer(answers[prevIdx] || '');
      }
    }
  };
  
  // 重新开�?
  const restart = () => {
    setQuestions([]);
    setCurrentIndex(0);
    setAnswers([]);
    setResults([]);
    setCurrentResult(null);
    setIsFinished(false);
    setSelectedOption('');
    setShortAnswer('');
    setDifficulty('');
  };

  // 实现更新复习状态函�?
  const updateReviewStatus = async (needsReview) => {
    try {
      await apiClient.put(`/knowledge-points/${id}`, { reviewList: needsReview });
      console.log(`�?�?{needsReview ? '加入' : '移除'}复习列表`);
    } catch (error) {
      console.error('更新复习状态失�?', error);
    }
  };

  if (!knowledgePoint) return <p>加载�?..</p>;

  return (
    <div style={{ maxWidth: '800px', margin: '0 auto', padding: '20px' }}>
      <h1>知识点测�? {knowledgePoint.title}</h1>
      
      {/* 题型切换�?*/}
      <div style={{ marginBottom: '20px' }}>
        <label style={{ marginRight: '10px', fontWeight: 'bold' }}>题型: </label>
        <button 
          onClick={() => setQuestionType('single-choice')}
          disabled={questions.length > 0}
          style={{ 
            background: questionType === 'single-choice' ? '#6366f1' : '#e5e7eb',
            color: questionType === 'single-choice' ? 'white' : '#374151',
            padding: '8px 16px',
            marginRight: '10px',
            border: 'none',
            borderRadius: '8px',
            cursor: questions.length > 0 ? 'not-allowed' : 'pointer',
            opacity: questions.length > 0 ? 0.5 : 1,
            fontSize: '1rem'
          }}
        >
          单选题
        </button>
        <button 
          onClick={() => setQuestionType('short-answer')}
          disabled={questions.length > 0}
          style={{ 
            background: questionType === 'short-answer' ? '#6366f1' : '#e5e7eb',
            color: questionType === 'short-answer' ? 'white' : '#374151',
            padding: '8px 16px',
            border: 'none',
            borderRadius: '8px',
            cursor: questions.length > 0 ? 'not-allowed' : 'pointer',
            opacity: questions.length > 0 ? 0.5 : 1,
            fontSize: '1rem'
          }}
        >
          简答题
        </button>
      </div>
      
      {/* 题目数量选择�?*/}
      {questions.length === 0 && (
        <div style={{ marginBottom: '20px' }}>
          <label style={{ marginRight: '10px', fontWeight: 'bold' }}>题目数量: </label>
          <input 
            type="number" 
            min="1" 
            max="10" 
            value={questionCount} 
            onChange={(e) => setQuestionCount(Math.max(1, Math.min(10, parseInt(e.target.value) || 1)))}
            disabled={isLoading}
            style={{
              padding: '8px 12px',
              borderRadius: '8px',
              border: '1px solid #ccc',
              fontSize: '1rem',
              width: '80px'
            }}
          />
          <span style={{ marginLeft: '10px', color: '#6b7280' }}>�?-10题）</span>
        </div>
      )}
      
      {/* 难度选择按钮 */}
      {questions.length === 0 && (
        <div style={{ marginBottom: '20px' }}>
          <p style={{ fontWeight: 'bold', marginBottom: '10px' }}>选择难度:</p>
          {['基础', '中等', '困难'].map(diff => (
            <button 
              key={diff}
              onClick={() => fetchQuestions(diff, questionCount)}
              disabled={isLoading}
              style={{ 
                padding: '10px 20px',
                marginRight: '10px',
                borderRadius: '8px',
                border: 'none',
                background: '#6366f1',
                color: 'white',
                cursor: isLoading ? 'not-allowed' : 'pointer',
                opacity: isLoading ? 0.5 : 1,
                fontSize: '1rem',
                fontWeight: '500'
              }}
            >
              {diff}
            </button>
          ))}
        </div>
      )}
      
      <hr />
      
      {/* 加载状�?*/}
      {isLoading && (
        <div style={{ textAlign: 'center', padding: '40px' }}>
          <p style={{ fontSize: '1.2rem', color: '#6366f1', marginBottom: '10px' }}>AI正在生成 {questionCount} 道题�?..</p>
          <p style={{ color: '#6b7280' }}>请稍候，预计需�?{questionCount * 6} �?/p>
        </div>
      )}
      
      {/* 题目显示区域 */}
      {questions.length > 0 && !isFinished && (
        <div>
          {/* 进度�?*/}
          <div style={{ marginBottom: '20px', padding: '15px', background: '#f3f4f6', borderRadius: '8px' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '10px' }}>
              <span style={{ fontWeight: 'bold' }}>题目进度: {currentIndex + 1} / {questions.length}</span>
              <span style={{ color: '#6b7280' }}>难度: {difficulty}</span>
            </div>
            <div style={{ background: '#e5e7eb', height: '8px', borderRadius: '4px', overflow: 'hidden' }}>
              <div style={{ 
                background: '#6366f1', 
                height: '100%', 
                width: `${((currentIndex + 1) / questions.length) * 100}%`,
                transition: 'width 0.3s'
              }} />
            </div>
          </div>
          
          <form onSubmit={handleSubmit}>
            <h3 style={{ marginBottom: '20px', fontSize: '1.3rem' }}>
              �?{currentIndex + 1} �? {questions[currentIndex].question}
            </h3>
            
            {questionType === 'single-choice' ? (
              <div>
                {Object.entries(questions[currentIndex].options).map(([key, value]) => (
                  <div key={key} style={{ 
                    marginBottom: '12px', 
                    padding: '12px',
                    border: selectedOption === key ? '2px solid #6366f1' : '1px solid #e5e7eb',
                    borderRadius: '8px',
                    background: selectedOption === key ? '#ede9fe' : '#fff',
                    cursor: 'pointer',
                    transition: 'all 0.2s'
                  }}
                  onClick={() => setSelectedOption(key)}
                  >
                    <input
                      type="radio"
                      id={`q${currentIndex}-${key}`}
                      name="option"
                      value={key}
                      checked={selectedOption === key}
                      onChange={(e) => setSelectedOption(e.target.value)}
                      style={{ marginRight: '10px' }}
                    />
                    <label htmlFor={`q${currentIndex}-${key}`} style={{ fontSize: '1rem', cursor: 'pointer' }}>
                      {key}. {value}
                    </label>
                  </div>
                ))}
              </div>
            ) : (
              <div>
                <textarea
                  value={shortAnswer}
                  onChange={(e) => setShortAnswer(e.target.value)}
                  placeholder="请用自己的话回答..."
                  style={{
                    width: '100%',
                    minHeight: '150px',
                    padding: '12px',
                    borderRadius: '8px',
                    border: '1px solid #ccc',
                    fontSize: '1rem',
                    fontFamily: 'inherit'
                  }}
                />
              </div>
            )}
            
            {/* 已答题显示结�?*/}
            {(() => {
              console.log('🐛 DEBUG - 检查currentResult:', currentResult);
              console.log('🐛 DEBUG - 检查results[currentIndex]:', results[currentIndex]);
              console.log('🐛 DEBUG - currentResult是否为truthy:', !!currentResult);
              console.log('🐛 DEBUG - results[currentIndex]是否为truthy:', !!results[currentIndex]);
              return null;
            })()}
            {results[currentIndex] && (
              <div 
                data-result-area
                style={{
                marginTop: '20px',
                padding: '15px',
                background: results[currentIndex].isCorrect ? '#d1fae5' : '#fee2e2',
                borderRadius: '8px',
                border: `2px solid ${results[currentIndex].isCorrect ? '#10b981' : '#ef4444'}`
              }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>
                  <p style={{ 
                    color: results[currentIndex].isCorrect ? '#065f46' : '#991b1b',
                    fontWeight: 'bold',
                    fontSize: '1.1rem',
                    margin: 0
                  }}>
                    {results[currentIndex].isCorrect ? '�?回答正确' : '�?回答错误'}
                  </p>
                  {questionType === 'short-answer' && results[currentIndex].score !== undefined && (
                    <span style={{
                      padding: '6px 16px',
                      borderRadius: '20px',
                      background: results[currentIndex].score >= 90 ? '#d1fae5' :
                                   results[currentIndex].score >= 70 ? '#dbeafe' :
                                   results[currentIndex].score >= 60 ? '#fef3c7' : '#fee2e2',
                      color: results[currentIndex].score >= 90 ? '#065f46' :
                             results[currentIndex].score >= 70 ? '#1e40af' :
                             results[currentIndex].score >= 60 ? '#92400e' : '#991b1b',
                      fontWeight: 'bold',
                      fontSize: '1.1rem'
                    }}>
                      {results[currentIndex].score}�?
                    </span>
                  )}
                </div>
                
                {questionType === 'single-choice' ? (
                  <>
                    <p style={{ marginTop: '8px' }}>
                      <strong>你的答案:</strong> {results[currentIndex].userAnswer} | 
                      <strong> 正确答案:</strong> {results[currentIndex].correctAnswer}
                    </p>
                    <p style={{ marginTop: '8px' }}><strong>解释:</strong> {results[currentIndex].explanation}</p>
                  </>
                ) : (
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                    {/* 分析 */}
                    {results[currentIndex].analysis && (
                      <div style={{ 
                        padding: '12px', 
                        background: '#f3f4f6', 
                        borderRadius: '8px',
                        border: '1px solid #e5e7eb'
                      }}>
                        <p style={{ fontWeight: 'bold', marginBottom: '8px', color: '#1f2937', fontSize: '0.95rem' }}>
                          🔍 答案分析
                        </p>
                        <p style={{ color: '#374151', lineHeight: '1.7', margin: 0 }}>{results[currentIndex].analysis}</p>
                      </div>
                    )}
                    
                    {/* 改进建议 */}
                    {results[currentIndex].suggestions && (
                      <div style={{ 
                        padding: '12px', 
                        background: '#fef3c7', 
                        borderRadius: '8px',
                        border: '1px solid #fbbf24'
                      }}>
                        <p style={{ fontWeight: 'bold', marginBottom: '8px', color: '#92400e', fontSize: '0.95rem' }}>
                          💡 改进建议
                        </p>
                        <p style={{ color: '#78350f', lineHeight: '1.7', margin: 0 }}>{results[currentIndex].suggestions}</p>
                      </div>
                    )}
                    
                    {/* 标准答案 */}
                    {results[currentIndex].standardAnswer && (
                      <div style={{ 
                        padding: '12px', 
                        background: '#dbeafe', 
                        borderRadius: '8px',
                        border: '1px solid #60a5fa'
                      }}>
                        <p style={{ fontWeight: 'bold', marginBottom: '8px', color: '#1e40af', fontSize: '0.95rem' }}>
                          📚 标准答案
                        </p>
                        <p style={{ color: '#1e3a8a', lineHeight: '1.7', margin: 0 }}>{results[currentIndex].standardAnswer}</p>
                      </div>
                    )}
                  </div>
                )}
              </div>
            )}
            
            <div style={{ marginTop: '20px', display: 'flex', gap: '10px', justifyContent: 'space-between' }}>
              <div style={{ display: 'flex', gap: '10px' }}>
                <button 
                  type="button"
                  onClick={prevQuestion}
                  disabled={currentIndex === 0}
                  style={{
                    padding: '10px 20px',
                    background: '#e5e7eb',
                    color: '#374151',
                    border: 'none',
                    borderRadius: '8px',
                    cursor: currentIndex === 0 ? 'not-allowed' : 'pointer',
                    opacity: currentIndex === 0 ? 0.5 : 1,
                    fontSize: '1rem'
                  }}
                >
                  �?上一�?
                </button>
                
                <button 
                  type="submit" 
                  disabled={isGrading}
                  style={{
                    padding: '10px 20px',
                    background: '#10b981',
                    color: 'white',
                    border: 'none',
                    borderRadius: '8px',
                    fontSize: '1rem',
                    cursor: isGrading ? 'not-allowed' : 'pointer',
                    opacity: isGrading ? 0.5 : 1,
                    fontWeight: '500'
                  }}
                >
                  {isGrading ? '�?评分�?..' : '提交答案'}
                </button>
                
                <button 
                  type="button"
                  onClick={handleNext}
                  disabled={currentIndex === questions.length - 1}
                  style={{
                    padding: '10px 20px',
                    background: '#6366f1',
                    color: 'white',
                    border: 'none',
                    borderRadius: '8px',
                    cursor: currentIndex === questions.length - 1 ? 'not-allowed' : 'pointer',
                    opacity: currentIndex === questions.length - 1 ? 0.5 : 1,
                    fontSize: '1rem',
                    fontWeight: '500'
                  }}
                >
                  下一�?�?
                </button>
              </div>
              
              <button 
                type="button"
                onClick={restart}
                style={{
                  padding: '10px 20px',
                  background: '#f59e0b',
                  color: 'white',
                  border: 'none',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontSize: '1rem'
                }}
              >
                重新开�?
              </button>
            </div>
          </form>
        </div>
      )}
      
      {/* 所有题目完成后的统计结�?*/}
      {isFinished && (
        <div style={{ 
          marginTop: '30px', 
          padding: '30px', 
          background: '#f9fafb',
          borderRadius: '12px',
          border: '2px solid #6366f1'
        }}>
          <h2 style={{ color: '#6366f1', marginBottom: '20px' }}>🎉 测评完成�?/h2>
          
          {/* 正确率统�?*/}
          <div style={{ 
            display: 'grid', 
            gridTemplateColumns: 'repeat(3, 1fr)', 
            gap: '15px',
            marginBottom: '25px'
          }}>
            <div style={{ padding: '15px', background: '#fff', borderRadius: '8px', textAlign: 'center', border: '1px solid #e5e7eb' }}>
              <p style={{ fontSize: '0.9rem', color: '#6b7280', marginBottom: '5px' }}>总题�?/p>
              <p style={{ fontSize: '2rem', fontWeight: 'bold', color: '#374151' }}>{questions.length}</p>
            </div>
            <div style={{ padding: '15px', background: '#d1fae5', borderRadius: '8px', textAlign: 'center', border: '1px solid #10b981' }}>
              <p style={{ fontSize: '0.9rem', color: '#065f46', marginBottom: '5px' }}>正确</p>
              <p style={{ fontSize: '2rem', fontWeight: 'bold', color: '#065f46' }}>
                {results.filter(r => r.isCorrect).length}
              </p>
            </div>
            <div style={{ padding: '15px', background: '#fee2e2', borderRadius: '8px', textAlign: 'center', border: '1px solid #ef4444' }}>
              <p style={{ fontSize: '0.9rem', color: '#991b1b', marginBottom: '5px' }}>错误</p>
              <p style={{ fontSize: '2rem', fontWeight: 'bold', color: '#991b1b' }}>
                {results.filter(r => !r.isCorrect).length}
              </p>
            </div>
          </div>
          
          <div style={{ 
            padding: '20px', 
            background: '#6366f1', 
            borderRadius: '8px',
            textAlign: 'center',
            marginBottom: '25px'
          }}>
            <p style={{ color: 'white', fontSize: '1.1rem', marginBottom: '5px' }}>正确�?/p>
            <p style={{ color: 'white', fontSize: '3rem', fontWeight: 'bold' }}>
              {Math.round((results.filter(r => r.isCorrect).length / questions.length) * 100)}%
            </p>
          </div>
          
          {/* 题目明细 */}
          <h3 style={{ marginBottom: '15px' }}>题目明细</h3>
          <div style={{ maxHeight: '400px', overflowY: 'auto' }}>
            {questions.map((q, idx) => (
              <div key={idx} style={{ 
                marginBottom: '15px',
                padding: '15px',
                background: '#fff',
                borderRadius: '8px',
                border: `2px solid ${results[idx].isCorrect ? '#10b981' : '#ef4444'}`
              }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px' }}>
                  <span style={{ fontWeight: 'bold' }}>�?{idx + 1} �?/span>
                  <span style={{ 
                    padding: '4px 12px',
                    borderRadius: '12px',
                    fontSize: '0.9rem',
                    fontWeight: 'bold',
                    background: results[idx].isCorrect ? '#d1fae5' : '#fee2e2',
                    color: results[idx].isCorrect ? '#065f46' : '#991b1b'
                  }}>
                    {results[idx].isCorrect ? '�?正确' : '�?错误'}
                  </span>
                </div>
                <p style={{ color: '#374151', marginBottom: '8px' }}>{q.question}</p>
                {questionType === 'single-choice' ? (
                  <p style={{ fontSize: '0.9rem', color: '#6b7280' }}>
                    你的答案: <strong>{results[idx].userAnswer}</strong> | 
                    正确答案: <strong>{results[idx].correctAnswer}</strong>
                  </p>
                ) : (
                  results[idx].score !== undefined && (
                    <div style={{ marginTop: '8px' }}>
                      <span style={{
                        padding: '4px 12px',
                        borderRadius: '12px',
                        fontSize: '0.95rem',
                        fontWeight: 'bold',
                        background: results[idx].score >= 90 ? '#d1fae5' :
                                     results[idx].score >= 70 ? '#dbeafe' :
                                     results[idx].score >= 60 ? '#fef3c7' : '#fee2e2',
                        color: results[idx].score >= 90 ? '#065f46' :
                               results[idx].score >= 70 ? '#1e40af' :
                               results[idx].score >= 60 ? '#92400e' : '#991b1b'
                      }}>
                        得分: {results[idx].score} / 100
                      </span>
                    </div>
                  )
                )}
              </div>
            ))}
          </div>
          
          {results.some(r => !r.isCorrect) && (
            <p style={{ 
              marginTop: '20px',
              padding: '12px',
              background: '#fef3c7',
              borderRadius: '8px',
              color: '#92400e',
              fontWeight: '500'
            }}>
              ⚠️ 检测到错题，该知识点已加入你的复习列表
            </p>
          )}
          
          <div style={{ marginTop: '25px', display: 'flex', gap: '10px' }}>
            <button 
              onClick={restart}
              style={{
                flex: 1,
                padding: '12px 20px',
                background: '#6366f1',
                color: 'white',
                border: 'none',
                borderRadius: '8px',
                cursor: 'pointer',
                fontSize: '1rem',
                fontWeight: '500'
              }}
            >
              再来一�?
            </button>
            <button 
              onClick={() => navigate('/')}
              style={{
                flex: 1,
                padding: '12px 20px',
                background: '#e5e7eb',
                color: '#374151',
                border: 'none',
                borderRadius: '8px',
                cursor: 'pointer',
                fontSize: '1rem',
                fontWeight: '500'
              }}
            >
              返回主页
            </button>
          </div>
        </div>
      )}
    </div>
  );
}

export default QuizPage;

