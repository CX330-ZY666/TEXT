# 二次编辑页面语音功能 - 测试指南\n\n## 修复总结\n\n### ✅ 已完成的修复\n\n#### 1. 前端 getUserMedia 双重调用问题（已修复）\n**症状**：点击\"开始录音\"按钮后，自动跳转回主页\n**根因**：\n- `FeynmanRecordPage.jsx` 中 `setupVolumeMeter()` 和 `handleStart()` 各自调用一次 `getUserMedia()`\n- 浏览器弹出两个权限对话框或权限冲突\n- 权限被拒绝导致异常处理中的路由跳转\n\n**修复方案**：\n- ✅ 合并两个 `getUserMedia()` 为单一调用\n- ✅ `handleStart()` 获取 stream → 将其传递给 `setupVolumeMeter(stream)`\n- ✅ 同样修复了 `VoiceRecorder.jsx`\n- ✅ 代码已编译验证无误\n\n#### 2. 后端百度 API 集成（待实施）\n详见 `百度API集成说明.md`\n\n---\n\n## 测试流程\n\n### 前置条件\n1. 浏览器已清除对麦克风权限的拒绝设置\n   - Chrome: Settings → Privacy → Site settings → Microphone → 移除此网站的拒绝\n   - Firefox: 相同的权限设置\n\n2. 麦克风正常工作\n\n3. 后端服务已启动在 `localhost:3000`\n\n### 场景 A：前端修复验证（不需要百度 API）\n\n**步骤**：\n1. 打开项目首页\n2. 创建或选择一个知识点\n3. 点击\"开始复述\"进入 `/feynman/:id` 页面\n4. 点击\"开始录音\"按钮\n5. **预期结果**：\n   - ✅ 不应该跳转回主页\n   - ✅ 状态显示\"recording\"\n   - ✅ 音量条应该实时显示\n   - ✅ 计时器开始计时\n\n6. 说几句话\n7. 点击\"停止录音\"\n8. **预期结果**：\n   - ✅ 录音停止\n   - ✅ 下方音频播放器显示已录制的音频\n   - ✅ 等待后端转录结果\n\n### 场景 B：完整流程（需要百度 API）\n\n**前提**：后端已集成百度 API 并配置好凭证（见 `百度API集成说明.md`）\n\n**步骤**：\n1. 完成场景 A 的步骤 1-7\n2. 等待 5-10 秒\n3. **预期结果**：\n   - ✅ 后端接收音频文件\n   - ✅ 调用百度语音识别 API\n   - ✅ 返回转录结果\n   - ✅ 前端显示转录文本在\"AI 转录结果\"区域\n   - ✅ 用户可编辑该文本\n   - ✅ 点击\"保存复述\"保存到数据库\n\n---\n\n## 常见问题排查\n\n### Q1：点击\"开始录音\"后仍然跳回主页\n\n**可能原因 1**：浏览器权限被拒绝\n- **解决方案**：清除浏览器设置中对麦克风的拒绝权限\n- Chrome: Settings → Privacy → Site settings → Microphone\n- 重新加载页面，重试\n\n**可能原因 2**：浏览器控制台有 JavaScript 错误\n- **解决方案**：\n  - 打开浏览器 F12 控制台\n  - 查看 Console 标签是否有红色错误\n  - 截图错误信息提供给开发者\n\n**可能原因 3**：后端服务未启动\n- **解决方案**：\n  - 确认后端服务在 `localhost:3000` 正在运行\n  - 检查 axios 配置（`src/api/axios.js`）中 baseURL 是否正确\n\n### Q2：录音停止后，转录结果一直显示\"正在上传并转录，请稍候...\"\n\n**可能原因**：后端的 `/api/audio/transcribe` 端点未实现或返回异常\n- **解决方案**：\n  - 检查后端日志\n  - 验证 `百度API集成说明.md` 中的代码是否已添加到后端\n  - 检查百度 API 凭证是否正确配置在 `.env`\n\n### Q3：转录结果显示\"转录失败: 转录结果为空，请稍后重试。\"\n\n**可能原因**：百度 API 未返回有效结果\n- 音频质量差（环境噪音太大、话筒离得太远）\n- 百度 API 配额已用尽\n- API 凭证过期\n\n**解决方案**：\n- 确保在安静的环境中清晰地说话\n- 检查百度智能云控制台的配额使用情况\n- 验证 .env 中的 App ID 和 API Key 是否正确\n\n### Q4：浏览器控制台显示\"TypeError: setupVolumeMeter is not a function\"\n\n**原因**：代码修复不完整或文件未重新加载\n- **解决方案**：\n  - 清空浏览器缓存（Ctrl+Shift+Delete）\n  - 硬刷新页面（Ctrl+Shift+R）\n  - 重新启动前端开发服务器\n\n---\n\n## 改进建议\n\n1. **音频质量优化**\n   - 可以调整 RecordRTC 的参数以适应不同的网络环境\n   - 考虑在上传前压缩音频\n\n2. **错误重试机制**\n   - 实现自动重试机制（如网络超时）\n   - 提供用户友好的错误提示\n\n3. **离线支持**\n   - 暂存已录制的音频，待网络恢复后再上传\n   - 使用 IndexedDB 或 localStorage 保存临时数据\n\n4. **性能优化**\n   - 使用动态导入分离音频相关的库（RecordRTC）\n   - 考虑 Web Worker 处理音频处理任务\n\n---\n\n## 文件修改清单\n\n✅ `src/pages/FeynmanRecordPage.jsx`\n- 修改 `setupVolumeMeter()` 签名，接收 stream 参数\n- 修改 `handleStart()` 合并 getUserMedia 调用\n\n✅ `src/components/VoiceRecorder.jsx`  \n- 同步修改 `setupVolumeMeter()` 和 `handleStart()`\n\n📝 `百度API集成说明.md` (新增)\n- 后端集成指南（两种方案）\n\n📝 `测试指南.md` (本文件)\n- 完整的测试和排查步骤\n\n---\n\n## 下一步\n\n1. 确认前端修复有效（场景 A 测试通过）\n2. 在后端实现百度 API 集成（见 `百度API集成说明.md`）\n3. 进行完整流程测试（场景 B）\n4. 提交代码到版本控制\n\n---\n\n**最后更新**：2025-11-06\n**前端编译状态**：✅ 成功（无错误）\n**测试状态**：⏳ 待执行\n"